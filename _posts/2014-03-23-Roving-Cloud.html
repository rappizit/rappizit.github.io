---
layout: post
title: Roving Cloud
date:   2014-03-23 19:38:00
categories: graphics-basic
tags: noise cloud
---
        <div>
            <div  style="position:relative; float:center">
                <canvas id="canvas" width="600" height="200">
                    
                    <img src="/image/canvas.png"></img>
                </canvas>
                </br>
                Source: <a href="http://www.flashandmath.com/intermediate/clouds/">Realistic White Clouds on Blue Sky in AS3 Flash</a>.</br>
                Optimization: <a href="http://www.flashandmath.com/intermediate/cloudsfast/">AS3 Flash: Low CPU Clouds Animation - Perfect for Mobile</a>.</br>
            </div>
        </div>
		
        <script src="/script/simplex-noise.min.js"></script>
        <script src="/script/ImageData.js"></script>
        <script src="/script/ColorMatrixFilter.js"></script>
        <script src="/script/PerlinNoiseScroller.js"></script>
        <script>
                var canvas = document.getElementById("canvas");
                var ctx = canvas.getContext("2d");
                var W = canvas.width;
                var H = canvas.height;
                var numOctaves = 5;
                var offsets = [];
                for (var i = 0; i < numOctaves; ++i) {
                    offsets[i] = {x:0, y:0};
                }
                var cmf = new ColorMatrixFilter([
                        0, 0, 0, 0, 255,
                        0, 0, 0, 0, 255,
                        0, 0, 0, 0, 255,
                        1, 0, 0, 0, 0,
                    ]);

                ctx.fillStyle = "#2255aa";  //sky(background) color
                ctx.globalCompositeOperation = "destination-over";
/*
                //original slow version
                var perlinBitmap = ctx.createImageData(W, H);
                setInterval(function() { 
                    for (var i = 0; i < numOctaves; ++i) {
                        offsets[i].x += 1;
                        offsets[i].y += 0.2;
                    }
                    perlinBitmap.perlinNoise(150, 150, numOctaves, 0, false, true, 1, false, offsets, 0.25, 2.5);
                    perlinBitmap.applyFilter(perlinBitmap, null, null, cmf);
                    ctx.putImageData(perlinBitmap, 0, 0);
                    ctx.fillRect(0, 0, W, H);   //draw sky

                }, 8);
*/

/*
                //optimized version, use tilable perlin noise map to scroll endlessly
                var perlinBitmap = ctx.createImageData(W / 2 * 3, H / 2 * 3);   //1.5x size can hide the repetition
                perlinBitmap.perlinNoise(200, 200, numOctaves, 0, true, true, 1, false, offsets, 0.25, 2.5);
                perlinBitmap.applyFilter(perlinBitmap, null, null, cmf);
                var scroller = new ImageDataScroller(perlinBitmap, 5);
                setInterval(function() { 
                    scroller.scroll(-1, 2);
                    ctx.putImageData(scroller.getImageData(), 0, 0);
                    ctx.fillRect(0, 0, W, H);   //draw sky

                }, 8);
*/

///*
                //2014-03-30 updated: optimized version, scroll a non-tilable perlin noise map
                var perlinBitmap = ctx.createImageData(W, H);
                var copyBitmap = ctx.createImageData(W, H);
                var fast = true;    //switch two versions, fast and slow
                var scroller = new PerlinNoiseScroller(perlinBitmap, 2, 2, !fast, 240, 240, numOctaves, 0, false, true, 1, false, offsets, 0.2, 3);
                copyBitmap.copyPixels(perlinBitmap);
                copyBitmap.applyFilter(perlinBitmap, null, null, cmf);
                
                (function animLoop(){
                    scroller.scroll(-2, 1);
                    if (fast) {
                        copyBitmap.scroll(-2, 1);
                        var rectV = scroller.getPasteRectV();
                        var rectH = scroller.getPasteRectH();
                        copyBitmap.applyFilter(perlinBitmap, rectV, {x:rectV.l, y:rectV.t}, cmf);
                        copyBitmap.applyFilter(perlinBitmap, rectH, {x:rectH.l, y:rectH.t}, cmf);
                    } else {
                        copyBitmap.applyFilter(perlinBitmap, null, null, cmf);
                    }
                    ctx.putImageData(copyBitmap, 0, 0);
                    ctx.fillRect(0, 0, W, H);   //draw sky
                    requestAnimationFrame(animLoop);
                })();

//*/

        </script>
		
		

